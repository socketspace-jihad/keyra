use futures_lite::io::{AsyncBufReadExt, AsyncReadExt, AsyncWriteExt, BufReader, BufWriter};
use glommio::{io::DmaStreamReader, net::TcpListener, LocalExecutorPoolBuilder, PoolPlacement};
use loggix::{error, with_fields};
use jemallocator::Jemalloc;

#[global_allocator]
static GLOBAL: Jemalloc = Jemalloc;

const OP_SET: u8 = 1;
const OP_GET: u8 = 2;

const MAX_PAYLOAD_BUFFER: usize = 1024;


#[inline(always)]
async fn handle_client(stream: glommio::net::TcpStream) {
    

    let mut buffer = [0u8; MAX_PAYLOAD_BUFFER+4];
    let resp_ok = b"OK"; 

    loop {
        // 1. Baca Header
        if stream.read_exact(&mut buffer).await.is_err() { break; }

        let op = buffer[0];
        let key_len = buffer[1] as usize;
        let val_len = u16::from_be_bytes([buffer[2], buffer[3]]) as usize;
        
        if key_len + val_len > MAX_PAYLOAD_BUFFER { break; }

        // 2. Baca Key dan Value ke dalam buffer stack
        let total_read_len = key_len + val_len;
        if reader.read_exact(&mut buffer[..total_read_len]).await.is_err() { 
            break;
        }
        
        match op {
            OP_SET => {
                if stream.write_all(resp_ok).await.is_err() { break; }
            }
            OP_GET => {
                if stream.write_all(b"NF").await.is_err() { break; }
            }
            _ => break,
        }
        
        if let Err(_) = stream.flush().await { 
             break;
        }
    }
}

fn main() {
    let addr = "0.0.0.0:4000";
    with_fields!("addr".to_string() => &addr).info("keyra protocol is listening");

    LocalExecutorPoolBuilder::new(PoolPlacement::MaxSpread(num_cpus::get(), None))
        .on_all_shards(move || async move {
            let listener = TcpListener::bind(&addr).expect("Gagal bind");


            loop {
                let stream = match listener.accept().await {
                    Ok(s) => s,
                    Err(e) => {
                        error!(e.to_string());
                        continue;
                    }
                };


                glommio::spawn_local(async move {
                    let _ = stream.set_nodelay(true);
                    handle_client(stream).await;
                }).detach();

                glommio::yield_if_needed().await;
            }
        })
        .expect("Gagal spawn pool")
        .join_all();
}
